## Pre-Requisite

Before running the signer service, you need to obtain Affinidi credentials from the Affinidi Portal.

> [!IMPORTANT]
> Mandatory steps before proceeding to next steps.

### Create Personal Access Token (PAT)

Personal Access Token (PAT) is like a machine user that acts on your behalf to the Affinidi services. You can use the PAT to authenticate to the Affinidi services and automate specific tasks within your application. A Personal Access Token (PAT) lives outside of Projects, meaning PAT can access multiple projects once granted by the user.

- More details: [Personal Access Token](https://docs.affinidi.com/dev-tools/affinidi-cli/manage-token/#how-does-pat-authentication-works)
- PAT is needed for `Affinidi TDK Auth provider`.

You can refer the [Affinidi Documentation](https://docs.affinidi.com/dev-tools/affinidi-cli/manage-token/#affinidi-token-create-token) for creating pesronal access token from CLI.

**Steps to Create PAT(Personal Access Token):**

1. **Log in to Affinidi CLI:**

   ```sh
   affinidi start
   ```

2. **Create a token:**

   ```sh
   affinidi token create-token
   ```

   Follow the instruction

   ```
    ? Enter the value for name workshopPAT
    ? Generate a new keypair for the token? yes
    ? Enter a passphrase to encrypt the private key. Leave it empty for no encryption ******
    ? Add token to active project and grant permissions? yes
    ? Enter the allowed resources, separated by spaces. Use * to allow access to all project resources *
    ? Enter the allowed actions, separated by spaces. Use * to allow all actions *
   ```

   **Sample response:**

   ```json
    Creating Personal Access Token... Created successfully!
    Adding token to active project... Added successfully!
    Granting permissions to token... Granted successfully!
    {
      "id": "**********",
      "ari": "ari:iam:::token/**********",
      "ownerAri": "ari:iam:::user/**********",
      "name": "workshopPAT",
      "scopes": [
        "openid",
        "offline_access"
      ],
      "authenticationMethod": {
        "type": "PRIVATE_KEY",
        "signingAlgorithm": "RS256",
        "publicKeyInfo": {
          "jwks": {
            "keys": [
              {
                "use": "sig",
                "kty": "RSA",
                "kid": "**********",
                "alg": "RS256",
                "n": "**********",
                "e": "AQAB"
              }
            ]
          }
        }
      }
    }

    Use the projectId, tokenId, privateKey, and passphrase (if provided) to use this token with Affinidi TDK
    {
      "tokenId": "*******",
      "projectId": "*******",
      "privateKey": "*******",
      "passphrase": "******"
    }
    â€º   Warning:
    â€º   Please save the privateKey and passphrase (if provided) somewhere safe. You will not be able to view them again.
    â€º

   ```

   For more details on the command run the below command

   ```sh
   affinidi token create-token --help
   ```

## âš™ï¸ Environment Variable Setup

update your `.env` file (or relevant environment configuration) with the following variables:

```env
PROJECT_ID=your_affinidi_project_id
TOKEN_ID=your_token_id
PASSPHRASE=your_passphrase
PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----
PORT=8454
```

## ğŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend Layer                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Chat Frontend (Port 3000)   â”‚  Merchant Portal (Port 3001)     â”‚
â”‚  - React + TypeScript        â”‚  - React + TypeScript            â”‚
â”‚  - Tailwind CSS              â”‚  - Tailwind CSS                  â”‚
â”‚  - Vite Dev Server           â”‚  - Vite Dev Server               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                              â”‚
               â”‚ HTTP                         â”‚ HTTP
               â”‚                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Chat Backend (Port 8452)   â”‚  â”‚ Merchant Backend (Port 8453) â”‚
â”‚   ========================   â”‚  â”‚ ===========================  â”‚
â”‚   â€¢ UCP Client               â”‚  â”‚ â€¢ UCP Server                 â”‚
â”‚   â€¢ AP2 Consumer Agent       â”‚  â”‚ â€¢ AP2 Merchant Agent         â”‚
â”‚   â€¢ Credentials Provider     â”‚  â”‚ â€¢ Payment Processor          â”‚
â”‚   â€¢ FastAPI                  â”‚  â”‚ â€¢ FastAPI                    â”‚
â”‚   â€¢ Ollama LLM Integration   â”‚  â”‚ â€¢ Ollama (Merchant Agent)    â”‚
â”‚   â€¢ Shopping Assistant       â”‚  â”‚ â€¢ SQLite Database            â”‚
â”‚   â€¢ WebAuthn Passkeys        â”‚  â”‚ â€¢ Product Catalog            â”‚
â”‚   â€¢ Encrypted Card Storage   â”‚  â”‚ â€¢ CRUD API                   â”‚
â”‚   â€¢ Logout Feature           â”‚  â”‚ â€¢ Request Logging            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|â”€â”€â”˜
               â”‚                              â”‚               |
               â”‚    UCP REST Protocol         â”‚               | 1.Startup: Create Did:web Wallet & Host did Doc
               â”‚    /.well-known/ucp          â”‚               | /.well-known/did.json
               â”‚    /ucp/v1/checkout-sessions â”‚               | 2.Checkout: Sign Cart Mandate with Wallet
               â”‚    /ucp/products/search      â”‚               | 3.Payment: Verify Mandate
               â”‚                              â”‚               |
               â”‚    AP2 via UCP Checkout      â”‚               â”‚
               â”‚    (No direct AP2 endpoints) â”‚               â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                                                              â”‚
                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                â”‚ Signer Service (Port 8454)   â”‚
                                                â”‚ ===========================  â”‚
                                                â”‚ â€¢ DID:web Wallet Management  â”‚
                                                â”‚ â€¢ JWT-VC Signing (Affinidi)  â”‚
                                                â”‚ â€¢ Credential Verification    â”‚
                                                â”‚                              â”‚
                                                â”‚ ğŸ” Endpoints:                â”‚
                                                â”‚ 1. POST /api/did-web-generateâ”‚
                                                â”‚ 2. POST /api/sign-credential â”‚
                                                â”‚ 3. POST /api/verify-credential
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
                                                             â”‚ Affinidi TDK
                                                             â”‚ (Wallets + Signing + Verification)
                                                             â–¼
                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”‚   Affinidi Infrastructure      â”‚
                                                â”‚   =========================    â”‚
                                                â”‚ â€¢ DID:web Registry             â”‚
                                                â”‚ â€¢ Key Management (Signing)     â”‚
                                                â”‚ â€¢ JWT-VC Signing/Verification  â”‚
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“‹ Credential Flow:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â‘  Merchant Startup  â†’ Call Signer: DID Generation â†’ Store DID doc (.well-known)
â‘¡ Checkout Created  â†’ Call Signer: Sign Credential â†’ Merchant's DID:web signature
â‘¢ Payment Process   â†’ Call Signer: Verify Credential â†’ Cryptographic verification
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

## ğŸ” Signer Service Details

### Three Core Endpoints

#### 1ï¸âƒ£ DID Generation (`POST /api/did-web-generate`)

**Purpose**: Creates or retrieves a `did:web` wallet for a domain

**Request**:

```json
{
  "domain": "localhost:8453"
}
```

**Response**:

```json
{
  "did": "did:web:localhost%3A8453",
  "did_document": { ... },
  "wallet_id": "...",
  "signing_key_id": "..."
}
```

**Integration**:

- Called during **Merchant Backend startup**
- DID document stored to serve `/.well-known/did.json`
- Wallet uses **Affinidi TDK** for key pair management

---

#### 2ï¸âƒ£ Sign Credential (`POST /api/sign-credential`)

**Purpose**: Signs JWT Verifiable Credentials using the wallet's private key

**Request**:

```json
{
  "domain": "localhost:8453",
  "unsigned_credential": {
    "@context": [...],
    "type": ["VerifiableCredential", "CartMandateCredential"],
    "credentialSubject": {
      "cartHash": "abc123...",
      "totalAmount": 150.00,
      ...
    }
  }
}
```

**Response**:

```json
{
  "signed_credential": "eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImRpZDp3ZWI6bG9jYWxob3N0..."
}
```

**Integration**:

- Called during **Checkout Session Update** (when payment mandate is added)
- Creates **Cart Mandate VC** signed by merchant's DID:web
- Signature proves merchant commits to cart contents and pricing

---

#### 3ï¸âƒ£ Verify Credential (`POST /api/verify-credential`)

**Purpose**: Verifies JWT-VC signature by resolving issuer's DID:web

**Request**:

```json
{
  "jwt_vc": "eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImRpZDp3ZWI6bG9jYWxob3N0..."
}
```

**Response**:

```json
{
  "valid": true,
  "verified": true,
  "errors": []
}
```

**Integration**:

- Called during **Payment Processing** (before completing payment)
- Verifies **Cart Mandate VC** hasn't been tampered with
- Resolves issuer DID and validates signature cryptographically

---

## ğŸ”„ Merchant Backend Integration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Merchant Backend Lifecycle                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. STARTUP (app lifespan)
   â”œâ”€ Initialize SignerClient(url="http://localhost:8454")
   â”œâ”€ Call: POST /api/did-web-generate
   â”‚  â””â”€ Domain: "localhost:8453" (or production domain)
   â”œâ”€ Receive: DID, DID Document, Wallet ID
   â””â”€ Store DID document â†’ serve at /.well-known/did.json

2. CHECKOUT SESSION UPDATE (add payment mandate)
   â”œâ”€ Build unsigned Cart Mandate credential
   â”‚  â””â”€ Contains: cartHash, totalAmount, currency, mandateId
   â”œâ”€ Call: POST /api/sign-credential
   â”‚  â””â”€ Domain + unsigned_credential
   â”œâ”€ Receive: Signed JWT-VC
   â””â”€ Store merchant_authorization in checkout session

3. PAYMENT PROCESSING (complete checkout)
   â”œâ”€ Extract merchant_authorization from payment mandate
   â”œâ”€ Call: POST /api/verify-credential
   â”‚  â””â”€ JWT-VC from merchant_authorization
   â”œâ”€ Receive: Verification result (valid/verified)
   â”œâ”€ If TESTFAIL promocode â†’ tampered JWT â†’ verification FAILS
   â””â”€ Proceed with payment ONLY if verification succeeds
```

---

## ğŸ›¡ï¸ Security Features

### DID:web Trust Model

- **Decentralized Identifiers**: No central authority required
- **Web-based Resolution**: DID document served via HTTPS
- **Public Key Distribution**: Verification keys published in DID document

### Cryptographic Signing

- **Affinidi TDK**: Enterprise-grade wallet management
- **ES256 Algorithm**: Elliptic Curve Digital Signature (ECDSA with P-256)
- **Non-repudiation**: Merchant cannot deny signing cart mandate

### Tamper Detection

- **Cart Hash**: SHA-256 hash of cart contents
- **Signature Verification**: Any modification breaks signature
- **Demo Feature**: TESTFAIL promocode simulates tampering for testing

---

## ğŸš€ Running the Signer Service

```bash
cd signer-server
./start.sh
```

**Health Check**:

```bash
curl http://localhost:8454/health
```

**Expected Response**:

```json
{
  "status": "healthy"
}
```

---

## ğŸ“¦ Dependencies

- **affinidi-tdk-wallets-client**: DID:web wallet creation and JWT signing
- **affinidi-tdk-credential-verification-client**: JWT-VC verification
- **affinidi-tdk-auth-provider**: Project-scoped authentication

---

## ğŸ§ª Testing Flow

1. **Start Signer Service**: `python main.py` (Port 8454)
2. **Start Merchant Backend**: Will auto-create DID:web wallet
3. **Create Checkout**: Cart mandate gets signed
4. **Normal Payment**: Verification succeeds â†’ payment processes
5. **Tamper Test**: Use promocode `TESTFAIL` â†’ verification fails â†’ payment rejected

---

## ğŸ“– Related Documentation

- [UCP Knowledge Base](../UCP-KNOWLEDGE-BASE.md)
- [Mastercard Integration](../MASTERCARD_INTEGRATION.md)
- [Affinidi TDK Documentation](https://docs.affinidi.com)
